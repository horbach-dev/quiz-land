generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid()) @map("_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @default(now()) @map("updated_at")
  username        String?
  telegram_id     String        @unique
  first_name      String?
  last_name       String?
  avatar          String?
  language        String
  authoredQuizzes Quiz[]
  sessions        QuizSession[]

  @@map("user")
}

model Quiz {
  id               String           @id @default(uuid()) @map("_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @default(now()) @map("updated_at")
  title            String
  description      String
  poster           String
  accessTo         String[]         @default([]) @map("access_to")
  isPublic         Boolean          @map("is_public")
  timeLimit        Int?             @map("time_limit")
  timeLimitChoice  Boolean?         @default(true) @map("time_limit_choice")
  positiveScore    Boolean?         @map("positive_score")
  type             QuizType         @default(USER_GENERATED)
  scoringAlgorithm ScoringAlgorithm @default(STRICT_MATCH)
  authorId         String           @map("author_id")
  authorTelegramId String           @map("author_telegram_id")
  author           User             @relation(fields: [authorId], references: [id])
  resultFeedbacks  Json?
  feedbackNotice   String?          @map("feedback_notice")
  questions        Question[]
  sessions         QuizSession[]

  @@map("quiz")
}

model QuizSession {
  id               String           @id @default(uuid()) @map("_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @default(now()) @map("updated_at")
  userId           String           @map("user_id")
  user             User             @relation(fields: [userId], references: [id])
  quizId           String           @map("quiz_id")
  quiz             Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  status           SessionStatus    @default(IN_PROGRESS)
  scoringAlgorithm ScoringAlgorithm
  feedback         String?
  feedbackNotice   String?          @map("feedback_notice")
  finalCategory    String?          @map("final_category") // если тест PERSONALITY_TEST
  startedAt        DateTime         @map("started_at")
  completedAt      DateTime?        @map("completed_at") // null пока не завершен
  timeSpentSeconds Int?             @default(0) @map("time_spent_seconds")
  score            Float?
  questions        Question[]
  userAnswers      UserAnswer[] // Связь с ответами пользователя в этой сессии

  @@map("quiz_session")
}

model Question {
  id            String           @id @default(uuid()) @map("_id")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @default(now()) @map("updated_at")
  text          String
  image         String?
  order         Int // порядок вопроса в квизе
  type          QuestionType // SINGLE_CHOICE, MULTI_CHOICE, TEXT_ANSWER
  field         QuestionField // ответ текстовый или картинка
  quizId        String           @map("quiz_id")
  quiz          Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options       QuestionOption[]
  userAnswers   UserAnswer[]
  QuizSession   QuizSession?     @relation(fields: [quizSessionId], references: [id])
  quizSessionId String?

  @@map("question")
}

model QuestionOption {
  id         String   @id @default(uuid()) @map("_id")
  text       String
  image      String?
  order      Int? // порядок ответа в вопросе
  isCorrect  Boolean  @map("is_correct")
  weight     Float?   @map("weight")
  questionId String   @map("question_id")
  quizId     String   @map("quiz_id")
  category   String?
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_option")
}

model UserAnswer {
  id                  String      @id @default(uuid()) @map("_id")
  sessionId           String      @map("session_id")
  session             QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId          String      @map("question_id")
  question            Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  submittedAnswerText String?     @map("submitted_answer_text")
  submittedOptionIds  String[]    @map("submitted_option_ids")
  isCorrect           Boolean?    @map("is_correct")

  @@unique([sessionId, questionId])
  @@map("user_answer")
}

enum QuizType {
  PLATFORM // квиз создан платформой
  USER_GENERATED // квиз создан пользователем
}

enum QuestionType {
  SINGLE_CHOICE // один вариант ответа
  MULTI_CHOICE // несколько вариантов
  TEXT_ANSWER // ответ текстом
}

enum QuestionField {
  TEXT
  IMAGE
}

enum ScoringAlgorithm {
  STRICT_MATCH // Строгое сравнение, ответы правильно / неправильно
  WEIGHTED_SCALE // Взвешенная шкала (тесты самочувствия, IQ и т.д)
  PERSONALITY_TEST // Тесты определения категории (пр. Холерик, Флегматик)
}

enum SessionStatus {
  IN_PROGRESS // в процессе выполения
  COMPLETED // пройден
  ABANDONED // завален
  TIMED_OUT // не пройден по времени
}
