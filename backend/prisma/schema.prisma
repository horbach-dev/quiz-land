generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid()) @map("_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @default(now()) @map("updated_at")
  username        String?
  telegram_id     String        @unique
  first_name      String?
  last_name       String?
  avatar          String?
  language        String
  authoredQuizzes Quiz[]
  sessions        QuizSession[]

  @@map("user")
}

model Quiz {
  id               String           @id @default(uuid()) @map("_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @default(now()) @map("updated_at")
  title            String
  description      String
  poster           String
  isPublic         Boolean          @map("is_public")
  limitedByTime    Boolean          @map("limited_by_time")
  type             QuizType         @default(USER_GENERATED)
  scoringAlgorithm ScoringAlgorithm @default(STRICT_MATCH)
  durationMinutes  Int?             @map("duration_minutes")
  authorId         String           @map("author_id")
  authorTelegramId String           @map("author_telegram_id")
  author           User             @relation(fields: [authorId], references: [id])
  questions        Question[]
  sessions         QuizSession[]

  @@map("quiz")
}

model QuizSession {
  id               String            @id @default(uuid()) @map("_id")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @default(now()) @map("updated_at")
  userId           String            @map("user_id")
  user             User              @relation(fields: [userId], references: [id])
  quizId           String            @map("quiz_id")
  quiz             Quiz              @relation(fields: [quizId], references: [id])
  status           SessionStatus     @default(IN_PROGRESS)
  scoringAlgorithm ScoringAlgorithm?
  startedAt        DateTime          @map("started_at")
  completedAt      DateTime?         @map("completed_at") // null пока не завершен
  timeSpentSeconds Int?              @map("time_spent_seconds")
  score            Float?
  userAnswers      UserAnswer[] // Связь с ответами пользователя в этой сессии

  @@map("quiz_session")
}

model Question {
  id          String           @id @default(uuid()) @map("_id")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @default(now()) @map("updated_at")
  text        String
  image       String?
  order       Int // Порядок вопроса в квизе
  type        QuestionType // SINGLE_CHOICE, MULTI_CHOICE, TEXT_ANSWER
  quizId      String           @map("quiz_id")
  quiz        Quiz             @relation(fields: [quizId], references: [id])
  options     QuestionOption[]
  userAnswers UserAnswer[]

  @@map("question")
}

model QuestionOption {
  id         String   @id @default(uuid()) @map("_id")
  text       String
  image      String?
  isCorrect  Boolean  @map("is_correct")
  weight     Float?   @map("weight")
  questionId String   @map("question_id")
  quizId     String   @map("quiz_id")
  question   Question @relation(fields: [questionId], references: [id])

  @@map("question_option")
}

model UserAnswer {
  id                  String      @id @default(uuid()) @map("_id")
  sessionId           String      @map("session_id")
  session             QuizSession @relation(fields: [sessionId], references: [id])
  questionId          String      @map("question_id")
  question            Question    @relation(fields: [questionId], references: [id])
  submittedAnswerText String?     @map("submitted_answer_text")
  submittedOptionIds  String[]    @map("submitted_option_ids")
  isCorrect           Boolean?    @map("is_correct")

  @@map("user_answer")
}

enum QuizType {
  PLATFORM // квиз создан платформой
  USER_GENERATED // квиз создан пользователем
}

enum QuestionType {
  SINGLE_CHOICE // один вариант ответа
  MULTI_CHOICE // несколько вариантов
  TEXT_ANSWER // ответ текстом
}

enum ScoringAlgorithm {
  STRICT_MATCH // Подход А (пользовательские квизы)
  PARTIAL_CREDIT // Подход Б
  WEIGHTED_SCALE // Взвешенная шкала (тесты самочувствия, IQ и т.д)
}

enum SessionStatus {
  IN_PROGRESS // в процессе выполения
  COMPLETED // пройден
  ABANDONED // завален
  TIMED_OUT // не пройден по времени
}
